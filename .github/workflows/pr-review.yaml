on:
  pull_request_target:
jobs:
  pr-review:
    if: github.repository != 'ConductorOne/github-workflows'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
    - name: Checkout PR head
      uses: actions/checkout@v5
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0
    - name: Checkout workflows repo
      uses: actions/checkout@v5
      with:
        repository: ConductorOne/github-workflows
        ref: add-pr-review-workflow # TODO: remove before merge
        path: _workflows
        sparse-checkout: skills
    - name: Install review skill
      run: |
        mkdir -p .claude/skills
        cp _workflows/skills/pr-review.md .claude/skills/pr-review.md
        rm -rf _workflows
    - name: Run Claude PR Review
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        use_sticky_comment: true
        track_progress: true
        include_fix_links: true
        claude_args: --max-turns 15
        prompt: |
          Use the /pr-review skill to review this PR.
